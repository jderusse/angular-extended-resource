"use strict";angular.module("exResource",["ngResource"]).run(["$interval","$xResourceCacheEngine",function(a,b){a(function(){b.gc()},3e5),b.gc()}]).factory("$xResourceConfig",function(){return{ttl:864e3,prefix:""}}).factory("$xResourceCacheEngine",["$window","$xResourceConfig",function(a,b){return{put:function(b,c){c=angular.copy(c),delete c.$promise,delete c.$resolved,delete c.$cache;var d=[(new Date).getTime(),c],e=JSON.stringify(d);angular.isUndefined(e)?delete a.localStorage[b]:a.localStorage[b]=e},get:function(b){var c=a.localStorage[b];if(angular.isUndefined(c)||"undefined"===c)return void 0;var d=JSON.parse(c),e=d[1];return e.$cache={updated:d[0],stale:!0},e},gc:function(){var c=(new Date).getTime();angular.forEach(a.localStorage,function(d,e){if(angular.isDefined(d)&&"undefined"!==d){var f=JSON.parse(d);angular.isArray(f)&&f.length>1&&f[0]+b.ttl<c&&delete a.localStorage[e]}})}}}]).provider("$xResource",function(){var a=this;this.defaults={actions:{get:{method:"GET",$cache:!0},query:{method:"GET",$cache:{key:!0,split:{"":!0}},isArray:!0}}},this.$get=["$window","$http","$log","$resource","$xResourceConfig","$xResourceCacheEngine",function(b,c,d,e,f,g){function h(){this._parsed={}}function i(){}function j(a,b,c){this.enabled=!0,this.template=a,this.paramDefaults=b||{},this.init(c)}h.prototype.encodeUriSegment=function(a){return this.encodeUriQuery(a,!0).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")},h.prototype.encodeUriQuery=function(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")},h.prototype.extractParams=function(a){if(!this._parsed[a]){var b=a,c={};angular.forEach(b.split(/\W/),function(a){if("hasOwnProperty"===a)throw angular.$$minErr("$xResource")("badname","hasOwnProperty is not a valid parameter name.");var d=new RegExp("(^|[^\\\\]):"+a+"(\\W|$)","g");a&&!/^\\d+$/.test(a)&&d.test(b)&&(c[a]=d)}),this._parsed[a]=c}return this._parsed[a]},h.prototype.render=function(a,b){var c=this,d=a,e=this.extractParams(a);return b=b||{},angular.forEach(e,function(a,e){var f,g=b.hasOwnProperty(e)?b[e]:void 0;angular.isDefined(g)&&null!==g?(f=c.encodeUriSegment(g),d=d.replace(a,function(a,b,c){return b+f+c})):d=d.replace(a,"")}),d=d.replace(/\\:/g,":"),d=d.replace(/\/+$/,"")||"/",d=d.replace(/\/\.(?=\w+($|\?))/,"."),d.replace(/\/\./,"/.")},i.MEMBER_NAME_REGEX=/^(\.[a-zA-Z_$][0-9a-zA-Z_$]*)+$/,i.prototype.isValidDottedPath=function(a){return null!==a&&""!==a&&"hasOwnProperty"!==a&&i.MEMBER_NAME_REGEX.test("."+a)},i.prototype.getElement=function(a,b){if(!this.isValidDottedPath(b))throw angular.$$minErr("badmember",'Dotted member path "@{0}" is invalid.',b);for(var c=b.split("."),d=0,e=c.length;e>d&&angular.isDefined(a);d++){var f=c[d];a=null!==a?a[f]:void 0}return a},i.prototype.changeElement=function(a,b,c){var d=this;if(""===b){if(angular.isArray(a)){var e=angular.copy(a);return a.length=0,angular.forEach(e,function(b){var d=c(b);angular.isDefined(d)&&a.push(c(b))}),a}return c(a)}if(!this.isValidDottedPath(b))throw angular.$$minErr("$xResource")("badmember",'Dotted member path "@{0}" is invalid.',b);var f=b.split("."),g=f.shift(),h=f.join(".");return angular.forEach(angular.isArray(a)?a:[a],function(a){angular.isDefined(a[g])&&(a[g]=d.changeElement(a[g],h,c))}),a},j.prototype.init=function(a){if(!angular.isObject(a))return this.init({key:a});if(a.key===!1)this.enabled=!1;else if(a.key===!0);else if(angular.isString(a.key))this.template=a.key;else{if(!angular.isFunction(a.key))throw angular.$$minErr("$xResource")("badmember","cacheKey property is not valid.");this.getKey=a.key}if(angular.isDefined(a.split)&&!angular.isObject(a.split))throw angular.$$minErr("$xResource")("badmember","cacheSplit property must be an object.");angular.isDefined(a.params)&&angular.extend(this.paramDefaults,a.params),this.splitProperties=[],this.splitConfigs=a.split||{};var b=this;angular.forEach(this.splitConfigs,function(a,c){b.splitProperties.push(c)})},j.prototype.extractParams=function(a,b,c){angular.isUndefined(c)&&(c=!0);var d={};return b=angular.extend({},b),angular.forEach(b,function(b,e){if(angular.isFunction(b)&&(b=b()),b&&b.charAt&&"@"===b.charAt(0)){var f=k.getElement(a,b.substr(1));d[e]=angular.isUndefined(f)&&!c?b:f}else d[e]=b}),d},j.prototype.getTemplateParams=function(a,b,c){return angular.extend({},this.extractParams(b,this.paramDefaults,c),a)},j.prototype.getKey=function(a){return f.prefix+l.render(this.template,a)},j.prototype.splitResource=function(a,b){var c=this;angular.forEach(this.splitProperties.sort().reverse(),function(d){var e=new j(c.template+"/"+d,b,c.splitConfigs[d]);k.changeElement(a,d,function(a){var b=e.store(a,{},a);return angular.isDefined(b)?"#"+b:void 0})})},j.prototype.store=function(a,b){if(this.enabled){a=angular.copy(a),this.splitProperties.length&&this.splitResource(a,this.getTemplateParams(b,a,!1));var c=this.getKey(this.getTemplateParams(b,a),a);return g.put(c,a),c}},j.prototype.joinResource=function(a){var b=this;angular.forEach(this.splitProperties.sort(),function(c){var d=new j(null,{},b.splitConfigs[c]);k.changeElement(a,c,function(a){if("#"===a[0]){var b=g.get(a.substr(1));return d.joinResource(b),b}return a})})},j.prototype.fetch=function(a,b){if(this.enabled){var c=this.getKey(this.getTemplateParams(a,b),null),d=g.get(c);return angular.isUndefined(d)?d:(this.splitProperties.length&&this.joinResource(d),d)}};var k=new i,l=new h,m=function(a,b,c,d,e){var f=function(){return/^(POST|PUT|PATCH)$/i.test(d.method)},g=function(a,b,c,d){var e,g,h,i={};switch(arguments.length){case 4:h=d,g=c;case 3:case 2:if(!angular.isFunction(b)){i=a,e=b,g=c;break}if(angular.isFunction(a)){g=a,h=b;break}g=b,h=c;case 1:angular.isFunction(a)?g=a:f()?e=a:i=a;break;case 0:break;default:throw angular.$$minErr("$xResource")("badargs","Expected up to 4 arguments [params, data, success, error], got {0} arguments",arguments.length)}return{params:i,data:e,success:g,error:h}},h=new j(d.url||b,angular.extend({},c,d.params),e);return function(){var b=a.apply(this,arguments),c=g.apply(this,arguments),d=h.fetch(c.params,c.data);return angular.isDefined(d)&&(angular.extend(b,d),b.$cache=d.$cache),b.$promise.then(function(){b.$cache=b.$cache||{updated:(new Date).getTime()},b.$cache.stale=!1,h.store(b,c.params)}),b}},n=function(a,b){return angular.isDefined(a[b])?a[b]:(d.error('Error in resource configuration. Expected response to contain a property "'+b+'" but got '+JSON.stringify(a)),a)};return function(b,d,f,g){f=angular.extend({},a.defaults.actions,f),angular.forEach(f,function(a){angular.isDefined(a.$accessProperty)&&(a.transformResponse=c.defaults.transformResponse.concat([function(b){return n(b,a.$accessProperty)}]))});var h=e(b,d,f,g);return angular.forEach(f,function(a,c){angular.isDefined(a.$cache)&&a.$cache!==!1&&(h[c]=m(h[c],b,d,a,a.$cache))}),h}}]});