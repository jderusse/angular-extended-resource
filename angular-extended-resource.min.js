"use strict";angular.module("exResource",["ngResource","LocalForageModule"]).run(["$interval","$xResourceCacheEngine",function(a,b){a(function(){b.gc()},3e5),b.gc()}]).constant("$xResourceConfig",{ttl:864e6,prefix:""}).factory("$xResourceCacheEngine",["$window","$xResourceConfig","$localForage",function(a,b,c){return{put:function(a,b){var d=function(b){delete b.$promise,delete b.$cachePromise,delete b.$resolved,delete b.$cache,c.setItem(a,[(new Date).getTime(),b])};angular.isArray(b)?d(angular.copy(b)):this.get(a).then(function(a){d(angular.extend({},a,b))})},get:function(a){return c.getItem(a).then(function(a){if(angular.isDefined(a)){var b=a[1];return b.$cache={updated:a[0],stale:!0},b}})},gc:function(){var a=(new Date).getTime();c.keys().then(function(d){angular.forEach(d,function(d){c.getItem(d).then(function(e){e[0]+b.ttl<a&&c.removeItem(d)})})})}}}]).provider("$xResource",function(){var a=this;this.defaults={actions:{get:{method:"GET",$cache:!0},query:{method:"GET",$cache:{key:!0,split:{"*":!0}},isArray:!0}}},this.$get=["$window","$http","$log","$resource","$xResourceConfig","$xResourceCacheEngine","$q",function(b,c,d,e,f,g,h){function i(){this._parsed={}}function j(){}function k(a,b,c){this.enabled=!0,this.template=a,this.paramDefaults=b||{},this.init(c)}i.prototype.encodeUriSegment=function(a){return this.encodeUriQuery(a,!0).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")},i.prototype.encodeUriQuery=function(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")},i.prototype.extractParams=function(a){if(!this._parsed[a]){var b=a,c={};angular.forEach(b.split(/\W/),function(a){if("hasOwnProperty"===a)throw angular.$$minErr("$xResource")("badname","hasOwnProperty is not a valid parameter name.");var d=new RegExp("(^|[^\\\\]):"+a+"(\\W|$)","g");a&&!/^\\d+$/.test(a)&&d.test(b)&&(c[a]=d)}),this._parsed[a]=c}return this._parsed[a]},i.prototype.render=function(a,b){var c=this,d=a,e=this.extractParams(a);return b=b||{},angular.forEach(e,function(a,e){var f,g=b.hasOwnProperty(e)?b[e]:void 0;angular.isDefined(g)&&null!==g?(f=c.encodeUriSegment(g),d=d.replace(a,function(a,b,c){return b+f+c})):d=d.replace(a,function(a,b,c){return b+c})}),d=d.replace(/\\:/g,":"),d=d.replace(/\/+$/,"")||"/",d=d.replace(/\/\.(?=\w+($|\?))/,"."),d.replace(/\/\./,"/.")},j.MEMBER_NAME_REGEX=/^(\.(\*|[a-zA-Z_$][0-9a-zA-Z_$]*))+$/,j.prototype.isValidDottedPath=function(a){return null!==a&&""!==a&&"hasOwnProperty"!==a&&j.MEMBER_NAME_REGEX.test("."+a)},j.prototype.getElement=function(a,b){if(!this.isValidDottedPath(b))throw angular.$$minErr("badmember",'Dotted member path "@{0}" is invalid.',b);for(var c=b.split("."),d=0,e=c.length;e>d&&angular.isDefined(a);d++){var f=c[d];a=null!==a?a[f]:void 0}return a},j.prototype.changeElement=function(a,b,c){var d=this;if(""===b)return c(a);if(!this.isValidDottedPath(b))throw angular.$$minErr("$xResource")("badmember",'Dotted member path "@{0}" is invalid.',b);var e=b.split("."),f=e.shift(),g=e.join(".");if("*"===f){if(!angular.isArray(a))throw angular.$$minErr("$xResource")("badmember",'Path "*" point to a non-array object.',b);angular.forEach(a,function(b,e){a[e]=d.changeElement(b,g,c)})}else{if(angular.isArray(a))throw angular.$$minErr("$xResource")("badmember",'Path "'+b+'" point to a array object.',b);angular.isDefined(a[f])&&(a[f]=d.changeElement(a[f],g,c))}return a},k.prototype.init=function(a){if(!angular.isObject(a))return this.init({key:a});if(a.key===!1)this.enabled=!1;else if(a.key===!0);else if(angular.isString(a.key))this.template=a.key;else{if(!angular.isFunction(a.key))throw angular.$$minErr("$xResource")("badmember","cacheKey property is not valid.");this.getKey=a.key}if(angular.isDefined(a.split)&&!angular.isObject(a.split))throw angular.$$minErr("$xResource")("badmember","cacheSplit property must be an object.");angular.isDefined(a.params)&&angular.extend(this.paramDefaults,a.params),this.splitProperties=[],this.splitConfigs=a.split||{};var b=this;angular.forEach(this.splitConfigs,function(a,c){b.splitProperties.push(c)})},k.prototype.extractParams=function(a,b,c){angular.isUndefined(c)&&(c=!0);var d={};return b=angular.extend({},b),angular.forEach(b,function(b,e){if(angular.isFunction(b)&&(b=b()),b&&b.charAt&&"@"===b.charAt(0)){var f=l.getElement(a,b.substr(1));d[e]=angular.isUndefined(f)&&!c?b:f}else d[e]=b}),d},k.prototype.getTemplateParams=function(a,b,c){return angular.extend({},this.extractParams(b,this.paramDefaults,c),a)},k.prototype.getKey=function(a){return f.prefix+m.render(this.template,a)},k.prototype.splitResource=function(a,b){var c=this;angular.forEach(this.splitProperties.sort().reverse(),function(d){var e=new k(c.template+"/"+d.replace(/(^\*|\.\*)/,""),b,c.splitConfigs[d]);l.changeElement(a,d,function(a){if(null===a)return null;var b=e.store(a,{},a);return angular.isDefined(b)?(angular.isArray(a)?"#@":"#$")+b:void 0})})},k.prototype.store=function(a,b){if(this.enabled){a=angular.copy(a),this.splitProperties.length&&this.splitResource(a,this.getTemplateParams(b,a,!1));var c=this.getKey(this.getTemplateParams(b,a),a);return g.put(c,a),c}},k.prototype.joinResource=function(a){var b=h.defer();b.counter=1;var c=function(){0===--b.counter&&b.resolve(a)},d=this;return angular.forEach(this.splitProperties.sort(),function(e){var f=new k(null,{},d.splitConfigs[e]);l.changeElement(a,e,function(a){if(angular.isString(a)){var d=a.substr(0,2);if("#$"===d||"#@"===d){var e="#$"===d?{}:[];return b.counter++,g.get(a.substr(2)).then(function(a){angular.extend(e,a),f.joinResource(e).then(function(){c()})}),e}return a}return a})}),c(),b.promise},k.prototype.fetch=function(a,b){if(this.enabled){var c=this.getKey(this.getTemplateParams(a,b),null),d=this,e=h.defer();return g.get(c).then(function(a){angular.isUndefined(a)?e.resolve(a):d.splitProperties.length?d.joinResource(a).then(function(){e.resolve(a)},function(a){e.reject(a)}):e.resolve(a)}),e.promise}};var l=new j,m=new i,n=function(a,b,c,d,e){var f=function(){return/^(POST|PUT|PATCH)$/i.test(d.method)},g=function(a,b,c,d){var e,g,h,i={};switch(arguments.length){case 4:h=d,g=c;case 3:case 2:if(!angular.isFunction(b)){i=a,e=b,g=c;break}if(angular.isFunction(a)){g=a,h=b;break}g=b,h=c;case 1:angular.isFunction(a)?g=a:f()?e=a:i=a;break;case 0:break;default:throw angular.$$minErr("$xResource")("badargs","Expected up to 4 arguments [params, data, success, error], got {0} arguments",arguments.length)}return{params:i,data:e,success:g,error:h}},i=new k(d.url||b,angular.extend({},c,d.params),e);return function(){var b=h.defer(),c=a.apply(this,arguments);c.$cachePromise=b.promise;var d=g.apply(this,arguments),e=i.fetch(d.params,d.data);return angular.isDefined(e)?e.then(function(a){angular.isUndefined(c.$cache)&&angular.isDefined(a)&&(angular.extend(c,a),c.$cache=a.$cache,b.resolve(c))},function(a){b.reject(a)}):b.resolve(c),c.$promise.then(function(){c.$cache=c.$cache||{updated:(new Date).getTime()},c.$cache.stale=!1,i.store(c,d.params),b.resolve(c)}),c}},o=function(a,b){return angular.isDefined(a[b])?a[b]:(d.error('Error in resource configuration. Expected response to contain a property "'+b+'" but got '+JSON.stringify(a)),a)};return function(b,d,f,g){f=angular.extend({},a.defaults.actions,f),angular.forEach(f,function(a){angular.isDefined(a.$accessProperty)&&(a.transformResponse=c.defaults.transformResponse.concat([function(b){return o(b,a.$accessProperty)}]))});var h=e(b,d,f,g);return angular.forEach(f,function(a,c){angular.isDefined(a.$cache)&&a.$cache!==!1&&(h[c]=n(h[c],b,d,a,a.$cache))}),h}}]});